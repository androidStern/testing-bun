# PROJECT KNOWLEDGE BASE

**Generated:** 2026-01-04
**Commit:** 2969c32
**Branch:** add-new-shad-theme

## OVERVIEW

Job board/referral platform: Convex backend + TanStack Start frontend + WorkOS AuthKit. Employers submit jobs via SMS/form, AI parses, posts to Circle.so. Seekers build profiles/resumes, apply to positions.

## STRUCTURE

```
./
├── convex/           # Backend: schema, queries, mutations, actions, Inngest workflows
│   ├── jobMatcher/   # AI agent for job matching (@convex-dev/agent)
│   ├── inngest/      # Async workflow processing
│   └── lib/          # Shared backend utilities (env, crypto, integrations)
├── src/              # TanStack Start frontend
│   ├── components/   # React components (shadcn/ui + custom)
│   ├── routes/       # File-based routing (TanStack Router)
│   └── lib/
│       └── schemas/  # Shared Zod schemas (frontend + Convex importable)
├── scrape-pipeline/  # Separate Bun server for job scraping
├── docs/             # Design documents
└── data/             # Static data (GTFS, fair-chance employers)
```

## WHERE TO LOOK

| Task | Location | Notes |
|------|----------|-------|
| Add Convex table | `convex/schema.ts` | Use `zodOutputToConvex` for Zod schemas |
| Add HTTP endpoint | `convex/http.ts` | Use Zod for input validation |
| Add admin function | Use `adminQuery`/`adminMutation` from `convex/functions.ts` |
| Auth flow | `src/router.tsx` | WorkOS AuthKit integration |
| New route | `src/routes/` | Auto-generated by dev server |
| Shared Zod schema | `src/lib/schemas/` | Importable by both frontend & Convex |
| Inngest workflow | `convex/inngest/` | Bridge via `inngestNode.ts` |
| Node.js action | `convex/*Node.ts` | Files needing Node runtime |

## SCHEMA & VALIDATION PATTERNS

### Single Source of Truth: Zod -> Convex -> Forms

**Schema locations:**

```
src/lib/schemas/     <- Shared schemas (profile.ts, resume.ts)
convex/lib/          <- Backend-only schemas (jobSchema.ts)
```

**1. Table definitions** (Zod -> Convex validator):

```typescript
// convex/schema.ts
import { zodOutputToConvex } from 'convex-helpers/server/zod4' // Must be zod4!
import { ParsedJobSchema } from './lib/jobSchema'

defineTable({
  parsedJob: v.optional(zodOutputToConvex(ParsedJobSchema)),
})
```

**2. Mutation args with Zod** (validates input directly):

```typescript
// convex/resumes.ts
import { zCustomMutation } from 'convex-helpers/server/zod4'
import { NoOp } from 'convex-helpers/server/customFunctions'
import { resumeMutationSchema } from '../src/lib/schemas/resume'

const zodMutation = zCustomMutation(mutation, NoOp)

export const upsert = zodMutation({
  args: resumeMutationSchema, // Zod schema as args!
  handler: async (ctx, args) => {
    /* ... */
  },
})
```

**3. TanStack Form validation** (same Zod schema):

```typescript
// CORRECT - ResumeForm.tsx
import { resumeFormSchema } from '@/lib/schemas/resume'

const form = useForm({
  validators: { onSubmit: resumeFormSchema }, // REQUIRED
  // ...
})
```

**Schema derivation pattern:**

```typescript
// Base for forms
export const resumeFormSchema = z.object({
  /* ... */
})

// Extended for mutations (adds auth fields)
export const resumeMutationSchema = resumeFormSchema.extend({
  workosUserId: z.string().min(1),
})

// Partial for updates
export const resumeUpdateSchema = resumeFormSchema.partial()
```

## CONVEX FUNCTION RULES

### 1. ALWAYS include `returns` validator

```typescript
// CORRECT
export const get = query({
  args: { id: v.id('profiles') },
  returns: v.union(profileDocValidator, v.null()), // REQUIRED
  handler: async (ctx, args) => {
    /* ... */
  },
})
```

### 2. Use `withIndex()` NOT `.filter()`

```typescript
// WRONG - uses filter() on query
const jobs = await ctx.db
  .query('jobSubmissions')
  .withIndex('by_sender', (q) => q.eq('senderId', args.senderId))
  .filter((q) => q.eq(q.field('status'), 'approved')) // BAD

// CORRECT - add compound index
// In schema: .index('by_sender_status', ['senderId', 'status'])
const jobs = await ctx.db
  .query('jobSubmissions')
  .withIndex('by_sender_status', (q) => q.eq('senderId', args.senderId).eq('status', 'approved'))
```

### 3. No `v.any()` - define proper validators

```typescript
// WRONG
returns: v.any()

// CORRECT - define the shape
returns: v.object({
  page: v.array(scrapedJobDocValidator),
  nextCursor: v.union(v.string(), v.null()),
})
```

### 4. Internal vs Public functions

```typescript
// Public (client-callable)
export const getProfile = query({
  /* ... */
})

// Internal (only other Convex functions)
export const getProfileInternal = internalQuery({
  /* ... */
})

// Admin-gated (requires ADMIN_EMAILS)
import { adminQuery } from './functions'
export const listPendingJobs = adminQuery({
  /* ... */
})
```

## NODE.JS RUNTIME RULE

### When to use `"use node"`:

- Inngest SDK (needs `node:async_hooks`)
- `nodemailer` (SMTP)
- Any `node:*` built-in modules

### File organization:

```
convex/
├── inngestNode.ts      <- "use node" - Inngest + email
├── inngest/handler.ts  <- "use node" - Inngest factory
├── http.ts             <- V8 runtime (httpAction)
└── *.ts                <- V8 runtime (default)
```

**Naming convention:** Suffix with `Node` for Node.js files.

### HTTP -> Node Bridge:

```typescript
// convex/http.ts (V8)
http.route({
  path: '/api/inngest',
  method: 'POST',
  handler: httpAction(async (ctx, request) => {
    return await ctx.runAction(internal.inngestNode.handle, {
      body: await request.text(),
      headers: headersToObject(request.headers),
      method: request.method,
      url: request.url,
    })
  }),
})
```

## ACCESS CONTROL

### Admin functions (from `convex/functions.ts`):

```typescript
import { adminQuery, adminMutation, adminAction } from './functions'

// Checks ADMIN_EMAILS env var against user's profile email
export const listPending = adminQuery({
  args: {},
  handler: async (ctx, args) => {
    /* ... */
  },
})
```

### API key for external services:

```typescript
// convex/http.ts
function verifyPipelineSecret(request: Request): boolean {
  return request.headers.get('X-Pipeline-Secret') === env.SCRAPE_PIPELINE_SECRET
}

http.route({
  handler: httpAction(async (ctx, request) => {
    if (!verifyPipelineSecret(request)) {
      return new Response('Unauthorized', { status: 401 })
    }
    // ...
  }),
})
```

## ANTI-PATTERNS

| Don't                          | Do Instead                                |
| ------------------------------ | ----------------------------------------- |
| `.filter()` on queries         | Add index, use `withIndex()`              |
| `returns: v.any()`             | Define proper validator                   |
| Skip `returns` validator       | Always include even for simple queries    |
| `require()` in Convex          | Use dynamic `import()` or restructure     |
| Forms without Zod validation   | Add `validators: { onSubmit: schema }`    |
| Manual route generation        | Let TanStack Start dev server handle it   |

## COMMANDS

```bash
bun run dev            # Frontend + backend + Inngest
bun run dev:frontend   # Vite (localhost:3000)
bun run dev:backend    # Convex dev
bun run dev:inngest    # Inngest local
bun run dev:scrape     # Scrape pipeline
bun run build && bun run start
bun run lint           # TypeScript + ESLint
```

## NOTES

- **Path aliases**: `@/*` and `~/*` -> `./src/*`
- **Zod version**: Using zod@4 with `convex-helpers/server/zod4`
- **Convex MCP**: Only connect to development deployments
